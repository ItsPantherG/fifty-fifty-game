{"ast":null,"code":"\"use strict\";\n\n/**\n * Copyright 2017 Google Inc. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nvar __classPrivateFieldSet = this && this.__classPrivateFieldSet || function (receiver, state, value, kind, f) {\n  if (kind === \"m\") throw new TypeError(\"Private method is not writable\");\n  if (kind === \"a\" && !f) throw new TypeError(\"Private accessor was defined without a setter\");\n  if (typeof state === \"function\" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError(\"Cannot write private member to an object whose class did not declare it\");\n  return kind === \"a\" ? f.call(receiver, value) : f ? f.value = value : state.set(receiver, value), value;\n};\nvar __classPrivateFieldGet = this && this.__classPrivateFieldGet || function (receiver, state, kind, f) {\n  if (kind === \"a\" && !f) throw new TypeError(\"Private accessor was defined without a getter\");\n  if (typeof state === \"function\" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError(\"Cannot read private member from an object whose class did not declare it\");\n  return kind === \"m\" ? f : kind === \"a\" ? f.call(receiver) : f ? f.value : state.get(receiver);\n};\nvar _Connection_instances, _Connection_transport, _Connection_delay, _Connection_lastId, _Connection_closed, _Connection_callbacks, _Connection_onClose;\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.Connection = void 0;\nconst Debug_js_1 = require(\"../Debug.js\");\nconst debugProtocolSend = (0, Debug_js_1.debug)('puppeteer:webDriverBiDi:SEND ►');\nconst debugProtocolReceive = (0, Debug_js_1.debug)('puppeteer:webDriverBiDi:RECV ◀');\nconst EventEmitter_js_1 = require(\"../EventEmitter.js\");\nconst Errors_js_1 = require(\"../Errors.js\");\n/**\n * @internal\n */\nclass Connection extends EventEmitter_js_1.EventEmitter {\n  constructor(transport) {\n    let delay = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 0;\n    super();\n    _Connection_instances.add(this);\n    _Connection_transport.set(this, void 0);\n    _Connection_delay.set(this, void 0);\n    _Connection_lastId.set(this, 0);\n    _Connection_closed.set(this, false);\n    _Connection_callbacks.set(this, new Map());\n    __classPrivateFieldSet(this, _Connection_delay, delay, \"f\");\n    __classPrivateFieldSet(this, _Connection_transport, transport, \"f\");\n    __classPrivateFieldGet(this, _Connection_transport, \"f\").onmessage = this.onMessage.bind(this);\n    __classPrivateFieldGet(this, _Connection_transport, \"f\").onclose = __classPrivateFieldGet(this, _Connection_instances, \"m\", _Connection_onClose).bind(this);\n  }\n  get closed() {\n    return __classPrivateFieldGet(this, _Connection_closed, \"f\");\n  }\n  send(method, params) {\n    var _a;\n    const id = __classPrivateFieldSet(this, _Connection_lastId, (_a = __classPrivateFieldGet(this, _Connection_lastId, \"f\"), ++_a), \"f\");\n    const stringifiedMessage = JSON.stringify({\n      id,\n      method,\n      params\n    });\n    debugProtocolSend(stringifiedMessage);\n    __classPrivateFieldGet(this, _Connection_transport, \"f\").send(stringifiedMessage);\n    return new Promise((resolve, reject) => {\n      __classPrivateFieldGet(this, _Connection_callbacks, \"f\").set(id, {\n        resolve,\n        reject,\n        error: new Errors_js_1.ProtocolError(),\n        method\n      });\n    });\n  }\n  /**\n   * @internal\n   */\n  async onMessage(message) {\n    if (__classPrivateFieldGet(this, _Connection_delay, \"f\")) {\n      await new Promise(f => {\n        return setTimeout(f, __classPrivateFieldGet(this, _Connection_delay, \"f\"));\n      });\n    }\n    debugProtocolReceive(message);\n    const object = JSON.parse(message);\n    if ('id' in object) {\n      const callback = __classPrivateFieldGet(this, _Connection_callbacks, \"f\").get(object.id);\n      // Callbacks could be all rejected if someone has called `.dispose()`.\n      if (callback) {\n        __classPrivateFieldGet(this, _Connection_callbacks, \"f\").delete(object.id);\n        if ('error' in object) {\n          callback.reject(createProtocolError(callback.error, callback.method, object));\n        } else {\n          callback.resolve(object.result);\n        }\n      }\n    } else {\n      this.emit(object.method, object.params);\n    }\n  }\n  dispose() {\n    __classPrivateFieldGet(this, _Connection_instances, \"m\", _Connection_onClose).call(this);\n    __classPrivateFieldGet(this, _Connection_transport, \"f\").close();\n  }\n}\nexports.Connection = Connection;\n_Connection_transport = new WeakMap(), _Connection_delay = new WeakMap(), _Connection_lastId = new WeakMap(), _Connection_closed = new WeakMap(), _Connection_callbacks = new WeakMap(), _Connection_instances = new WeakSet(), _Connection_onClose = function _Connection_onClose() {\n  if (__classPrivateFieldGet(this, _Connection_closed, \"f\")) {\n    return;\n  }\n  __classPrivateFieldSet(this, _Connection_closed, true, \"f\");\n  __classPrivateFieldGet(this, _Connection_transport, \"f\").onmessage = undefined;\n  __classPrivateFieldGet(this, _Connection_transport, \"f\").onclose = undefined;\n  for (const callback of __classPrivateFieldGet(this, _Connection_callbacks, \"f\").values()) {\n    callback.reject(rewriteError(callback.error, `Protocol error (${callback.method}): Connection closed.`));\n  }\n  __classPrivateFieldGet(this, _Connection_callbacks, \"f\").clear();\n};\nfunction rewriteError(error, message, originalMessage) {\n  error.message = message;\n  error.originalMessage = originalMessage !== null && originalMessage !== void 0 ? originalMessage : error.originalMessage;\n  return error;\n}\nfunction createProtocolError(error, method, object) {\n  let message = `Protocol error (${method}): ${object.error} ${object.message}`;\n  if (object.stacktrace) {\n    message += ` ${object.stacktrace}`;\n  }\n  return rewriteError(error, message, object.message);\n}","map":{"version":3,"mappings":";;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAgBA;AACA,MAAMA,iBAAiB,GAAG,oBAAK,EAAC,gCAAgC,CAAC;AACjE,MAAMC,oBAAoB,GAAG,oBAAK,EAAC,gCAAgC,CAAC;AAGpE;AACA;AA0BA;;;AAGA,MAAaC,UAAW,SAAQC,8BAAY;EAO1CC,YAAYC,SAA8B,EAAW;IAAA,IAATC,KAAK,uEAAG,CAAC;IACnD,KAAK,EAAE;;IAPTC;IACAC;IACAC,6BAAU,CAAC;IACXC,6BAAU,KAAK;IACfC,gCAA8C,IAAIC,GAAG,EAAE;IAIrDC,2BAAI,qBAAUP,KAAK;IAEnBO,2BAAI,yBAAcR,SAAS;IAC3BS,2BAAI,6BAAW,CAACC,SAAS,GAAG,IAAI,CAACC,SAAS,CAACC,IAAI,CAAC,IAAI,CAAC;IACrDH,2BAAI,6BAAW,CAACI,OAAO,GAAGJ,2BAAI,kDAAS,CAACG,IAAI,CAAC,IAAI,CAAC;EACpD;EAEA,IAAIE,MAAM;IACR,OAAOL,2BAAI,0BAAQ;EACrB;EAEAM,IAAI,CAACC,MAAc,EAAEC,MAAc;;IACjC,MAAMC,EAAE,GAAGV,kDAAEW,0DAAY,EAAd,IAAc;IACzB,MAAMC,kBAAkB,GAAGC,IAAI,CAACC,SAAS,CAAC;MACxCJ,EAAE;MACFF,MAAM;MACNC;KACU,CAAC;IACbtB,iBAAiB,CAACyB,kBAAkB,CAAC;IACrCX,2BAAI,6BAAW,CAACM,IAAI,CAACK,kBAAkB,CAAC;IACxC,OAAO,IAAIG,OAAO,CAAC,CAACC,OAAO,EAAEC,MAAM,KAAI;MACrChB,2BAAI,6BAAW,CAACiB,GAAG,CAACR,EAAE,EAAE;QACtBM,OAAO;QACPC,MAAM;QACNE,KAAK,EAAE,IAAIC,yBAAa,EAAE;QAC1BZ;OACD,CAAC;IACJ,CAAC,CAAC;EACJ;EAEA;;;EAGU,MAAML,SAAS,CAACkB,OAAe;IACvC,IAAIpB,2BAAI,yBAAO,EAAE;MACf,MAAM,IAAIc,OAAO,CAACO,CAAC,IAAG;QACpB,OAAOC,UAAU,CAACD,CAAC,EAAErB,2BAAI,yBAAO,CAAC;MACnC,CAAC,CAAC;;IAEJb,oBAAoB,CAACiC,OAAO,CAAC;IAC7B,MAAMG,MAAM,GAAGX,IAAI,CAACY,KAAK,CAACJ,OAAO,CAGd;IACnB,IAAI,IAAI,IAAIG,MAAM,EAAE;MAClB,MAAME,QAAQ,GAAGzB,2BAAI,6BAAW,CAAC0B,GAAG,CAACH,MAAM,CAACd,EAAE,CAAC;MAC/C;MACA,IAAIgB,QAAQ,EAAE;QACZzB,2BAAI,6BAAW,CAAC2B,MAAM,CAACJ,MAAM,CAACd,EAAE,CAAC;QACjC,IAAI,OAAO,IAAIc,MAAM,EAAE;UACrBE,QAAQ,CAACT,MAAM,CACbY,mBAAmB,CAACH,QAAQ,CAACP,KAAK,EAAEO,QAAQ,CAAClB,MAAM,EAAEgB,MAAM,CAAC,CAC7D;SACF,MAAM;UACLE,QAAQ,CAACV,OAAO,CAACQ,MAAM,CAACM,MAAM,CAAC;;;KAGpC,MAAM;MACL,IAAI,CAACC,IAAI,CAACP,MAAM,CAAChB,MAAM,EAAEgB,MAAM,CAACf,MAAM,CAAC;;EAE3C;EAoBAuB,OAAO;IACL/B,2BAAI,kDAAS,MAAb,IAAI,CAAW;IACfA,2BAAI,6BAAW,CAACgC,KAAK,EAAE;EACzB;;AA5FFC;;EAwEI,IAAIjC,2BAAI,0BAAQ,EAAE;IAChB;;EAEFD,2BAAI,sBAAW,IAAI;EACnBC,2BAAI,6BAAW,CAACC,SAAS,GAAGiC,SAAS;EACrClC,2BAAI,6BAAW,CAACI,OAAO,GAAG8B,SAAS;EACnC,KAAK,MAAMT,QAAQ,IAAIzB,2BAAI,6BAAW,CAACmC,MAAM,EAAE,EAAE;IAC/CV,QAAQ,CAACT,MAAM,CACboB,YAAY,CACVX,QAAQ,CAACP,KAAK,EACd,mBAAmBO,QAAQ,CAAClB,MAAM,uBAAuB,CAC1D,CACF;;EAEHP,2BAAI,6BAAW,CAACqC,KAAK,EAAE;AACzB,CAAC;AAQH,SAASD,YAAY,CACnBlB,KAAoB,EACpBE,OAAe,EACfkB,eAAwB;EAExBpB,KAAK,CAACE,OAAO,GAAGA,OAAO;EACvBF,KAAK,CAACoB,eAAe,GAAGA,eAAe,aAAfA,eAAe,cAAfA,eAAe,GAAIpB,KAAK,CAACoB,eAAe;EAChE,OAAOpB,KAAK;AACd;AAEA,SAASU,mBAAmB,CAC1BV,KAAoB,EACpBX,MAAc,EACdgB,MAAqB;EAErB,IAAIH,OAAO,GAAG,mBAAmBb,MAAM,MAAMgB,MAAM,CAACL,KAAK,IAAIK,MAAM,CAACH,OAAO,EAAE;EAC7E,IAAIG,MAAM,CAACgB,UAAU,EAAE;IACrBnB,OAAO,IAAI,IAAIG,MAAM,CAACgB,UAAU,EAAE;;EAEpC,OAAOH,YAAY,CAAClB,KAAK,EAAEE,OAAO,EAAEG,MAAM,CAACH,OAAO,CAAC;AACrD","names":["debugProtocolSend","debugProtocolReceive","Connection","EventEmitter_js_1","constructor","transport","delay","_Connection_transport","_Connection_delay","_Connection_lastId","_Connection_closed","_Connection_callbacks","Map","__classPrivateFieldSet","__classPrivateFieldGet","onmessage","onMessage","bind","onclose","closed","send","method","params","id","_a","stringifiedMessage","JSON","stringify","Promise","resolve","reject","set","error","Errors_js_1","message","f","setTimeout","object","parse","callback","get","delete","createProtocolError","result","emit","dispose","close","exports","undefined","values","rewriteError","clear","originalMessage","stacktrace"],"sources":["../../../../../src/common/bidi/Connection.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}