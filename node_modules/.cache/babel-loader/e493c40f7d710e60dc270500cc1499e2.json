{"ast":null,"code":"\"use strict\";\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.ChromeLauncher = void 0;\nconst fs_1 = __importDefault(require(\"fs\"));\nconst path_1 = __importDefault(require(\"path\"));\nconst Browser_js_1 = require(\"../common/Browser.js\");\nconst assert_js_1 = require(\"../util/assert.js\");\nconst BrowserRunner_js_1 = require(\"./BrowserRunner.js\");\nconst ProductLauncher_js_1 = require(\"./ProductLauncher.js\");\nconst util_js_1 = require(\"./util.js\");\n/**\n * @internal\n */\nclass ChromeLauncher {\n  constructor(preferredRevision, isPuppeteerCore) {\n    this._preferredRevision = preferredRevision;\n    this._isPuppeteerCore = isPuppeteerCore;\n  }\n  async launch() {\n    let options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n    const {\n      ignoreDefaultArgs = false,\n      args = [],\n      dumpio = false,\n      channel,\n      executablePath,\n      pipe = false,\n      env = process.env,\n      handleSIGINT = true,\n      handleSIGTERM = true,\n      handleSIGHUP = true,\n      ignoreHTTPSErrors = false,\n      defaultViewport = {\n        width: 800,\n        height: 600\n      },\n      slowMo = 0,\n      timeout = 30000,\n      waitForInitialPage = true,\n      debuggingPort\n    } = options;\n    const chromeArguments = [];\n    if (!ignoreDefaultArgs) {\n      chromeArguments.push(...this.defaultArgs(options));\n    } else if (Array.isArray(ignoreDefaultArgs)) {\n      chromeArguments.push(...this.defaultArgs(options).filter(arg => {\n        return !ignoreDefaultArgs.includes(arg);\n      }));\n    } else {\n      chromeArguments.push(...args);\n    }\n    if (!chromeArguments.some(argument => {\n      return argument.startsWith('--remote-debugging-');\n    })) {\n      if (pipe) {\n        (0, assert_js_1.assert)(!debuggingPort, 'Browser should be launched with either pipe or debugging port - not both.');\n        chromeArguments.push('--remote-debugging-pipe');\n      } else {\n        chromeArguments.push(`--remote-debugging-port=${debuggingPort || 0}`);\n      }\n    }\n    let isTempUserDataDir = false;\n    // Check for the user data dir argument, which will always be set even\n    // with a custom directory specified via the userDataDir option.\n    let userDataDirIndex = chromeArguments.findIndex(arg => {\n      return arg.startsWith('--user-data-dir');\n    });\n    if (userDataDirIndex < 0) {\n      isTempUserDataDir = true;\n      chromeArguments.push(`--user-data-dir=${await fs_1.default.promises.mkdtemp(path_1.default.join((0, util_js_1.tmpdir)(), 'puppeteer_dev_chrome_profile-'))}`);\n      userDataDirIndex = chromeArguments.length - 1;\n    }\n    const userDataDir = chromeArguments[userDataDirIndex].split('=', 2)[1];\n    (0, assert_js_1.assert)(typeof userDataDir === 'string', '`--user-data-dir` is malformed');\n    let chromeExecutable = executablePath;\n    if (channel) {\n      // executablePath is detected by channel, so it should not be specified by user.\n      (0, assert_js_1.assert)(!chromeExecutable, '`executablePath` must not be specified when `channel` is given.');\n      chromeExecutable = (0, ProductLauncher_js_1.executablePathForChannel)(channel);\n    } else if (!chromeExecutable) {\n      const {\n        missingText,\n        executablePath\n      } = (0, ProductLauncher_js_1.resolveExecutablePath)(this);\n      if (missingText) {\n        throw new Error(missingText);\n      }\n      chromeExecutable = executablePath;\n    }\n    const usePipe = chromeArguments.includes('--remote-debugging-pipe');\n    const runner = new BrowserRunner_js_1.BrowserRunner(this.product, chromeExecutable, chromeArguments, userDataDir, isTempUserDataDir);\n    runner.start({\n      handleSIGHUP,\n      handleSIGTERM,\n      handleSIGINT,\n      dumpio,\n      env,\n      pipe: usePipe\n    });\n    let browser;\n    try {\n      const connection = await runner.setupConnection({\n        usePipe,\n        timeout,\n        slowMo,\n        preferredRevision: this._preferredRevision\n      });\n      browser = await Browser_js_1.CDPBrowser._create(this.product, connection, [], ignoreHTTPSErrors, defaultViewport, runner.proc, runner.close.bind(runner), options.targetFilter);\n    } catch (error) {\n      runner.kill();\n      throw error;\n    }\n    if (waitForInitialPage) {\n      try {\n        await browser.waitForTarget(t => {\n          return t.type() === 'page';\n        }, {\n          timeout\n        });\n      } catch (error) {\n        await browser.close();\n        throw error;\n      }\n    }\n    return browser;\n  }\n  defaultArgs() {\n    let options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n    const chromeArguments = ['--allow-pre-commit-input', '--disable-background-networking', '--enable-features=NetworkServiceInProcess2', '--disable-background-timer-throttling', '--disable-backgrounding-occluded-windows', '--disable-breakpad', '--disable-client-side-phishing-detection', '--disable-component-extensions-with-background-pages', '--disable-default-apps', '--disable-dev-shm-usage', '--disable-extensions',\n    // TODO: remove AvoidUnnecessaryBeforeUnloadCheckSync below\n    // once crbug.com/1324138 is fixed and released.\n    // AcceptCHFrame disabled because of crbug.com/1348106.\n    '--disable-features=Translate,BackForwardCache,AcceptCHFrame,AvoidUnnecessaryBeforeUnloadCheckSync', '--disable-hang-monitor', '--disable-ipc-flooding-protection', '--disable-popup-blocking', '--disable-prompt-on-repost', '--disable-renderer-backgrounding', '--disable-sync', '--force-color-profile=srgb', '--metrics-recording-only', '--no-first-run', '--enable-automation', '--password-store=basic', '--use-mock-keychain',\n    // TODO(sadym): remove '--enable-blink-features=IdleDetection'\n    // once IdleDetection is turned on by default.\n    '--enable-blink-features=IdleDetection', '--export-tagged-pdf'];\n    const {\n      devtools = false,\n      headless = !devtools,\n      args = [],\n      userDataDir\n    } = options;\n    if (userDataDir) {\n      chromeArguments.push(`--user-data-dir=${path_1.default.resolve(userDataDir)}`);\n    }\n    if (devtools) {\n      chromeArguments.push('--auto-open-devtools-for-tabs');\n    }\n    if (headless) {\n      chromeArguments.push(headless === 'chrome' ? '--headless=chrome' : '--headless', '--hide-scrollbars', '--mute-audio');\n    }\n    if (args.every(arg => {\n      return arg.startsWith('-');\n    })) {\n      chromeArguments.push('about:blank');\n    }\n    chromeArguments.push(...args);\n    return chromeArguments;\n  }\n  executablePath(channel) {\n    if (channel) {\n      return (0, ProductLauncher_js_1.executablePathForChannel)(channel);\n    } else {\n      const results = (0, ProductLauncher_js_1.resolveExecutablePath)(this);\n      return results.executablePath;\n    }\n  }\n  get product() {\n    return 'chrome';\n  }\n}\nexports.ChromeLauncher = ChromeLauncher;","map":{"version":3,"mappings":";;;;;;;;;;;AAAA;AACA;AACA;AAEA;AACA;AAMA;AAKA;AAEA;;;AAGA,MAAaA,cAAc;EAUzBC,YAAYC,iBAAyB,EAAEC,eAAwB;IAC7D,IAAI,CAACC,kBAAkB,GAAGF,iBAAiB;IAC3C,IAAI,CAACG,gBAAgB,GAAGF,eAAe;EACzC;EAEA,MAAMG,MAAM,GAAyC;IAAA,IAAxCC,8EAAsC,EAAE;IACnD,MAAM;MACJC,iBAAiB,GAAG,KAAK;MACzBC,IAAI,GAAG,EAAE;MACTC,MAAM,GAAG,KAAK;MACdC,OAAO;MACPC,cAAc;MACdC,IAAI,GAAG,KAAK;MACZC,GAAG,GAAGC,OAAO,CAACD,GAAG;MACjBE,YAAY,GAAG,IAAI;MACnBC,aAAa,GAAG,IAAI;MACpBC,YAAY,GAAG,IAAI;MACnBC,iBAAiB,GAAG,KAAK;MACzBC,eAAe,GAAG;QAACC,KAAK,EAAE,GAAG;QAAEC,MAAM,EAAE;MAAG,CAAC;MAC3CC,MAAM,GAAG,CAAC;MACVC,OAAO,GAAG,KAAK;MACfC,kBAAkB,GAAG,IAAI;MACzBC;IAAa,CACd,GAAGnB,OAAO;IAEX,MAAMoB,eAAe,GAAG,EAAE;IAC1B,IAAI,CAACnB,iBAAiB,EAAE;MACtBmB,eAAe,CAACC,IAAI,CAAC,GAAG,IAAI,CAACC,WAAW,CAACtB,OAAO,CAAC,CAAC;KACnD,MAAM,IAAIuB,KAAK,CAACC,OAAO,CAACvB,iBAAiB,CAAC,EAAE;MAC3CmB,eAAe,CAACC,IAAI,CAClB,GAAG,IAAI,CAACC,WAAW,CAACtB,OAAO,CAAC,CAACyB,MAAM,CAACC,GAAG,IAAG;QACxC,OAAO,CAACzB,iBAAiB,CAAC0B,QAAQ,CAACD,GAAG,CAAC;MACzC,CAAC,CAAC,CACH;KACF,MAAM;MACLN,eAAe,CAACC,IAAI,CAAC,GAAGnB,IAAI,CAAC;;IAG/B,IACE,CAACkB,eAAe,CAACQ,IAAI,CAACC,QAAQ,IAAG;MAC/B,OAAOA,QAAQ,CAACC,UAAU,CAAC,qBAAqB,CAAC;IACnD,CAAC,CAAC,EACF;MACA,IAAIxB,IAAI,EAAE;QACR,sBAAM,EACJ,CAACa,aAAa,EACd,2EAA2E,CAC5E;QACDC,eAAe,CAACC,IAAI,CAAC,yBAAyB,CAAC;OAChD,MAAM;QACLD,eAAe,CAACC,IAAI,CAAC,2BAA2BF,aAAa,IAAI,CAAC,EAAE,CAAC;;;IAIzE,IAAIY,iBAAiB,GAAG,KAAK;IAE7B;IACA;IACA,IAAIC,gBAAgB,GAAGZ,eAAe,CAACa,SAAS,CAACP,GAAG,IAAG;MACrD,OAAOA,GAAG,CAACI,UAAU,CAAC,iBAAiB,CAAC;IAC1C,CAAC,CAAC;IACF,IAAIE,gBAAgB,GAAG,CAAC,EAAE;MACxBD,iBAAiB,GAAG,IAAI;MACxBX,eAAe,CAACC,IAAI,CAClB,mBAAmB,MAAMa,YAAE,CAACC,QAAQ,CAACC,OAAO,CAC1CC,cAAI,CAACC,IAAI,CAAC,oBAAM,GAAE,EAAE,+BAA+B,CAAC,CACrD,EAAE,CACJ;MACDN,gBAAgB,GAAGZ,eAAe,CAACmB,MAAM,GAAG,CAAC;;IAG/C,MAAMC,WAAW,GAAGpB,eAAe,CAACY,gBAAgB,CAAE,CAACS,KAAK,CAAC,GAAG,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC;IACvE,sBAAM,EAAC,OAAOD,WAAW,KAAK,QAAQ,EAAE,gCAAgC,CAAC;IAEzE,IAAIE,gBAAgB,GAAGrC,cAAc;IACrC,IAAID,OAAO,EAAE;MACX;MACA,sBAAM,EACJ,CAACsC,gBAAgB,EACjB,iEAAiE,CAClE;MAEDA,gBAAgB,GAAG,iDAAwB,EAACtC,OAAO,CAAC;KACrD,MAAM,IAAI,CAACsC,gBAAgB,EAAE;MAC5B,MAAM;QAACC,WAAW;QAAEtC;MAAc,CAAC,GAAG,8CAAqB,EAAC,IAAI,CAAC;MACjE,IAAIsC,WAAW,EAAE;QACf,MAAM,IAAIC,KAAK,CAACD,WAAW,CAAC;;MAE9BD,gBAAgB,GAAGrC,cAAc;;IAGnC,MAAMwC,OAAO,GAAGzB,eAAe,CAACO,QAAQ,CAAC,yBAAyB,CAAC;IACnE,MAAMmB,MAAM,GAAG,IAAIC,gCAAa,CAC9B,IAAI,CAACC,OAAO,EACZN,gBAAgB,EAChBtB,eAAe,EACfoB,WAAW,EACXT,iBAAiB,CAClB;IACDe,MAAM,CAACG,KAAK,CAAC;MACXtC,YAAY;MACZD,aAAa;MACbD,YAAY;MACZN,MAAM;MACNI,GAAG;MACHD,IAAI,EAAEuC;KACP,CAAC;IAEF,IAAIK,OAAO;IACX,IAAI;MACF,MAAMC,UAAU,GAAG,MAAML,MAAM,CAACM,eAAe,CAAC;QAC9CP,OAAO;QACP5B,OAAO;QACPD,MAAM;QACNrB,iBAAiB,EAAE,IAAI,CAACE;OACzB,CAAC;MACFqD,OAAO,GAAG,MAAMG,uBAAU,CAACC,OAAO,CAChC,IAAI,CAACN,OAAO,EACZG,UAAU,EACV,EAAE,EACFvC,iBAAiB,EACjBC,eAAe,EACfiC,MAAM,CAACS,IAAI,EACXT,MAAM,CAACU,KAAK,CAACC,IAAI,CAACX,MAAM,CAAC,EACzB9C,OAAO,CAAC0D,YAAY,CACrB;KACF,CAAC,OAAOC,KAAK,EAAE;MACdb,MAAM,CAACc,IAAI,EAAE;MACb,MAAMD,KAAK;;IAGb,IAAIzC,kBAAkB,EAAE;MACtB,IAAI;QACF,MAAMgC,OAAO,CAACW,aAAa,CACzBC,CAAC,IAAG;UACF,OAAOA,CAAC,CAACC,IAAI,EAAE,KAAK,MAAM;QAC5B,CAAC,EACD;UAAC9C;QAAO,CAAC,CACV;OACF,CAAC,OAAO0C,KAAK,EAAE;QACd,MAAMT,OAAO,CAACM,KAAK,EAAE;QACrB,MAAMG,KAAK;;;IAIf,OAAOT,OAAO;EAChB;EAEA5B,WAAW,GAA2C;IAAA,IAA1CtB,8EAAwC,EAAE;IACpD,MAAMoB,eAAe,GAAG,CACtB,0BAA0B,EAC1B,iCAAiC,EACjC,4CAA4C,EAC5C,uCAAuC,EACvC,0CAA0C,EAC1C,oBAAoB,EACpB,0CAA0C,EAC1C,sDAAsD,EACtD,wBAAwB,EACxB,yBAAyB,EACzB,sBAAsB;IACtB;IACA;IACA;IACA,mGAAmG,EACnG,wBAAwB,EACxB,mCAAmC,EACnC,0BAA0B,EAC1B,4BAA4B,EAC5B,kCAAkC,EAClC,gBAAgB,EAChB,4BAA4B,EAC5B,0BAA0B,EAC1B,gBAAgB,EAChB,qBAAqB,EACrB,wBAAwB,EACxB,qBAAqB;IACrB;IACA;IACA,uCAAuC,EACvC,qBAAqB,CACtB;IACD,MAAM;MACJ4C,QAAQ,GAAG,KAAK;MAChBC,QAAQ,GAAG,CAACD,QAAQ;MACpB9D,IAAI,GAAG,EAAE;MACTsC;IAAW,CACZ,GAAGxC,OAAO;IACX,IAAIwC,WAAW,EAAE;MACfpB,eAAe,CAACC,IAAI,CAAC,mBAAmBgB,cAAI,CAAC6B,OAAO,CAAC1B,WAAW,CAAC,EAAE,CAAC;;IAEtE,IAAIwB,QAAQ,EAAE;MACZ5C,eAAe,CAACC,IAAI,CAAC,+BAA+B,CAAC;;IAEvD,IAAI4C,QAAQ,EAAE;MACZ7C,eAAe,CAACC,IAAI,CAClB4C,QAAQ,KAAK,QAAQ,GAAG,mBAAmB,GAAG,YAAY,EAC1D,mBAAmB,EACnB,cAAc,CACf;;IAEH,IACE/D,IAAI,CAACiE,KAAK,CAACzC,GAAG,IAAG;MACf,OAAOA,GAAG,CAACI,UAAU,CAAC,GAAG,CAAC;IAC5B,CAAC,CAAC,EACF;MACAV,eAAe,CAACC,IAAI,CAAC,aAAa,CAAC;;IAErCD,eAAe,CAACC,IAAI,CAAC,GAAGnB,IAAI,CAAC;IAC7B,OAAOkB,eAAe;EACxB;EAEAf,cAAc,CAACD,OAA8B;IAC3C,IAAIA,OAAO,EAAE;MACX,OAAO,iDAAwB,EAACA,OAAO,CAAC;KACzC,MAAM;MACL,MAAMgE,OAAO,GAAG,8CAAqB,EAAC,IAAI,CAAC;MAC3C,OAAOA,OAAO,CAAC/D,cAAc;;EAEjC;EAEA,IAAI2C,OAAO;IACT,OAAO,QAAQ;EACjB;;AAzOFqB","names":["ChromeLauncher","constructor","preferredRevision","isPuppeteerCore","_preferredRevision","_isPuppeteerCore","launch","options","ignoreDefaultArgs","args","dumpio","channel","executablePath","pipe","env","process","handleSIGINT","handleSIGTERM","handleSIGHUP","ignoreHTTPSErrors","defaultViewport","width","height","slowMo","timeout","waitForInitialPage","debuggingPort","chromeArguments","push","defaultArgs","Array","isArray","filter","arg","includes","some","argument","startsWith","isTempUserDataDir","userDataDirIndex","findIndex","fs_1","promises","mkdtemp","path_1","join","length","userDataDir","split","chromeExecutable","missingText","Error","usePipe","runner","BrowserRunner_js_1","product","start","browser","connection","setupConnection","Browser_js_1","_create","proc","close","bind","targetFilter","error","kill","waitForTarget","t","type","devtools","headless","resolve","every","results","exports"],"sources":["../../../../src/node/ChromeLauncher.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}